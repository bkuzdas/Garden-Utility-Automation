################################################################################
# MOSQUITTO MQTT BROKER CONFIGURATION
# Garden & Utility Automation System
# By Brian Kuzdas - 03/02/2024 - Copyright (c) 2024 Brian Kuzdas
################################################################################
#
# PSEUDO CODE LOGIC:
# 1. Configure listener ports for MQTT and WebSocket connections
# 2. Enable authentication with password file
# 3. Set up persistence for message storage
# 4. Configure logging for troubleshooting
# 5. Define connection limits and timeouts
# 6. Enable anonymous connections (DISABLE in production!)
#
# COMMON LANGUAGE EXPLANATION:
# This configuration file tells the MQTT "post office" how to operate:
# - Which doors to open (ports) for receiving mail (messages)
# - Who is allowed to send mail (authentication)
# - How to remember important mail (persistence)
# - Where to write delivery logs (logging)
#
################################################################################

#------------------------------------------------------------------------------
# GENERAL SETTINGS
#------------------------------------------------------------------------------

# PSEUDO CODE: Set maximum simultaneous connections
# COMMON LANGUAGE: How many devices can connect at once
# For home automation: 50-100 is plenty (HA + ESP32s + mobile apps)
max_connections 100

# PSEUDO CODE: Allow connections from any IP address
# COMMON LANGUAGE: Accept connections from anywhere on the local network
# Use specific IP binding for security: listener 1883 192.168.1.100
listener 1883
protocol mqtt

#------------------------------------------------------------------------------
# WEBSOCKET LISTENER (Optional - for web browser connections)
#------------------------------------------------------------------------------

# PSEUDO CODE: Enable WebSocket protocol on port 9001
# COMMON LANGUAGE: Allows web browsers to connect to MQTT
# Useful for web-based dashboards
listener 9001
protocol websockets

#------------------------------------------------------------------------------
# AUTHENTICATION & SECURITY
#------------------------------------------------------------------------------

# PSEUDO CODE: IF allow_anonymous = true THEN anyone can connect ELSE require password
# COMMON LANGUAGE: Do we let strangers in, or check IDs at the door?
# 
# IMPORTANT SECURITY NOTE:
# - Development: allow_anonymous true (easy testing)
# - Production: allow_anonymous false (require authentication)
# 
# TO CREATE PASSWORD FILE:
# 1. docker exec -it garden_mqtt_broker sh
# 2. mosquitto_passwd -c /mosquitto/config/passwd <username>
# 3. Enter password when prompted
allow_anonymous true

# PSEUDO CODE: IF password_file is set THEN load user credentials FROM file
# COMMON LANGUAGE: Load the list of authorized users and their passwords
# Uncomment after creating password file (see above)
# password_file /mosquitto/config/passwd

#------------------------------------------------------------------------------
# PERSISTENCE (MESSAGE STORAGE)
#------------------------------------------------------------------------------

# PSEUDO CODE: Enable message persistence to disk
# COMMON LANGUAGE: Remember important messages even if broker restarts
# Critical for QoS 1 and 2 messages, retained messages
persistence true

# PSEUDO CODE: Set location for persistent storage
# COMMON LANGUAGE: Where to save the messages on disk
persistence_location /mosquitto/data/

# PSEUDO CODE: How often to save to disk (seconds)
# COMMON LANGUAGE: Save every 5 minutes or when messages accumulate
autosave_interval 300

# PSEUDO CODE: Restore retained messages on startup
# COMMON LANGUAGE: Remember and republish "sticky" messages when restarting
retained_persistence true

#------------------------------------------------------------------------------
# LOGGING CONFIGURATION
#------------------------------------------------------------------------------

# PSEUDO CODE: Set log destinations
# COMMON LANGUAGE: Where to write log messages
# Options: stdout, stderr, syslog, topic, file
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# PSEUDO CODE: Define log severity levels
# COMMON LANGUAGE: What types of events to log
# Options: error, warning, notice, information, debug
# 
# LOG LEVEL PSEUDO CODE:
# IF event = error THEN always log (broker failures)
# IF event = warning THEN log (connection issues, auth failures)
# IF event = notice THEN log (client connections, subscriptions)
# IF event = information THEN log (detailed operations)
# IF event = debug THEN log (everything for troubleshooting)
log_type error
log_type warning
log_type notice
log_type information

# PSEUDO CODE: Log connection events
# COMMON LANGUAGE: Write a note when devices connect or disconnect
connection_messages true

# PSEUDO CODE: Log timestamp format
# COMMON LANGUAGE: Include date and time in each log entry
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

#------------------------------------------------------------------------------
# CONNECTION SETTINGS & TIMEOUTS
#------------------------------------------------------------------------------

# PSEUDO CODE: Keep-alive timeout (seconds)
# COMMON LANGUAGE: If client doesn't send "I'm alive" signal, disconnect after this time
# Default is 60 seconds; increase for unreliable WiFi connections
keepalive_interval 60

# PSEUDO CODE: Maximum queued messages per client
# COMMON LANGUAGE: How many messages to buffer for offline clients
# Important for ESP32s that may temporarily lose WiFi
max_queued_messages 1000

# PSEUDO CODE: Maximum QoS (Quality of Service) level
# COMMON LANGUAGE: Highest message delivery guarantee level
# QoS 0 = At most once (fire and forget)
# QoS 1 = At least once (acknowledged)
# QoS 2 = Exactly once (guaranteed)
max_qos 2

#------------------------------------------------------------------------------
# PERFORMANCE TUNING
#------------------------------------------------------------------------------

# PSEUDO CODE: Maximum packet size (bytes)
# COMMON LANGUAGE: Largest message the broker will accept
# Default 0 = unlimited; set limit for safety
message_size_limit 1048576

# PSEUDO CODE: Memory limit for queued messages
# COMMON LANGUAGE: Maximum RAM to use for message buffering
# Set to 0 for unlimited (use with caution)
memory_limit 0

#------------------------------------------------------------------------------
# CLIENT BEHAVIOR
#------------------------------------------------------------------------------

# PSEUDO CODE: Allow client to specify persistent session
# COMMON LANGUAGE: Let devices request "remember my subscriptions"
# Important for offline message buffering
persistent_client_expiration 1h

#------------------------------------------------------------------------------
# BRIDGE CONFIGURATION (Optional - for external MQTT brokers)
#------------------------------------------------------------------------------

# PSEUDO CODE: IF you need to connect to external broker THEN configure bridge
# COMMON LANGUAGE: Connect this broker to another MQTT server
# Example: Connect to cloud MQTT for remote monitoring
# Uncomment and configure if needed

# connection cloud_bridge
# address mqtt.example.com:1883
# topic # both 0 garden_automation/ remote/garden_automation/
# bridge_attempt_unsubscribe true
# bridge_protocol_version mqttv311
# try_private true
# notifications false
# remote_username your_username
# remote_password your_password

#------------------------------------------------------------------------------
# MQTT 5.0 SETTINGS (Optional)
#------------------------------------------------------------------------------

# PSEUDO CODE: Enable MQTT 5.0 protocol features
# COMMON LANGUAGE: Use newest MQTT version with advanced features
# Most ESP32/ESPHome use MQTT 3.1.1, so this is optional
# max_packet_size 10240

#------------------------------------------------------------------------------
# ACCESS CONTROL LISTS (ACLs) - Advanced Security
#------------------------------------------------------------------------------

# PSEUDO CODE: IF acl_file is defined THEN enforce topic-level permissions
# COMMON LANGUAGE: Control which users can read/write specific topics
# Example ACL file format:
# user esp32_zone_a
# topic write garden/zone_a/#
# topic read garden/commands/#
#
# acl_file /mosquitto/config/acl.conf

################################################################################
# CONFIGURATION VALIDATION PSEUDO CODE
################################################################################
#
# ON_BROKER_START:
#   VALIDATE configuration file syntax
#   IF syntax errors THEN
#     LOG error message
#     EXIT with error code
#   ELSE
#     LOAD settings
#     INITIALIZE listeners on configured ports
#     IF authentication enabled THEN
#       LOAD password file
#       VERIFY file format
#     END IF
#     IF persistence enabled THEN
#       LOAD retained messages FROM persistence_location
#       RESTORE client sessions
#     END IF
#     START accepting connections
#     LOG "Mosquitto broker started successfully"
#   END IF
#
# ON_CLIENT_CONNECT:
#   IF allow_anonymous = false THEN
#     VERIFY username and password
#     IF invalid credentials THEN
#       REJECT connection
#       LOG authentication failure
#       RETURN
#     END IF
#   END IF
#   
#   ACCEPT connection
#   ASSIGN client session
#   LOG connection event with client_id and IP address
#   
#   IF client has persistent session THEN
#     RESTORE subscriptions
#     DELIVER queued messages
#   END IF
#
# ON_MESSAGE_PUBLISH:
#   VALIDATE topic format
#   CHECK ACL permissions (if enabled)
#   
#   FOR EACH subscriber TO topic:
#     IF QoS = 0 THEN
#       SEND message immediately
#       IF send fails THEN DROP message
#     ELSE IF QoS = 1 THEN
#       SEND message
#       WAIT for PUBACK acknowledgment
#       IF no PUBACK THEN RETRY sending
#     ELSE IF QoS = 2 THEN
#       SEND message
#       WAIT for PUBREC, PUBREL, PUBCOMP handshake
#       GUARANTEE exactly-once delivery
#     END IF
#   END FOR
#   
#   IF message is retained THEN
#     SAVE to persistence storage
#   END IF
#
################################################################################

# END OF MOSQUITTO CONFIGURATION

